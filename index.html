<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>Al-Quran Al-Karim ‚Äî ÿßŸÑŸÇÿ±ÿ¢ŸÜ ÿßŸÑŸÉÿ±ŸäŸÖ</title>
<meta name="description" content="Lisez et √©coutez le Saint Coran avec traduction"/>
<meta name="theme-color" content="#0a0d14"/>
<link rel="manifest" href="manifest.json"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet"/>
<style>
:root {
  --night: #0a0d14;
  --deep: #0f1520;
  --card: #141b2a;
  --card-hover: #1a2338;
  --gold: #c9a84c;
  --gold-light: #e8c97a;
  --gold-dim: #7a6030;
  --teal: #2a7a6e;
  --teal-light: #3da897;
  --text: #d4c5a0;
  --text-dim: #7a6e5a;
  --white: #f5f0e8;
  --completed: #1a3a2a;
  --completed-border: #2a7a4a;
  --green: #4ade80;
  --radius: 16px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--night);color:var(--text);font-family:'Lato',sans-serif;min-height:100vh;overflow-x:hidden;}
a{text-decoration:none;color:inherit;}
button{cursor:pointer;font-family:inherit;}

.bg-glow{position:fixed;top:-200px;left:50%;transform:translateX(-50%);width:800px;height:600px;background:radial-gradient(ellipse,rgba(201,168,76,.12),transparent 70%);pointer-events:none;z-index:0;}
.bg-pattern{position:fixed;inset:0;z-index:0;pointer-events:none;}
.bg-pattern svg{position:absolute;inset:0;width:100%;height:100%;opacity:.04;}

/* === VIEWS === */
.view{display:none;}
.view.active{display:block;}

/* === LOADING === */
.loading-overlay{position:fixed;inset:0;background:rgba(10,13,20,.97);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:9999;gap:20px;}
.loading-overlay.show{display:flex;}
.spinner{width:44px;height:44px;border:3px solid rgba(201,168,76,.2);border-top-color:var(--gold);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-family:'Amiri',serif;color:var(--gold);font-size:1.1rem;}

/* === TOAST === */
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-100px);background:var(--card);border:1px solid rgba(201,168,76,.3);color:var(--gold-light);padding:12px 24px;border-radius:12px;font-size:.85rem;z-index:9999;transition:transform .4s ease;pointer-events:none;}
.toast.show{transform:translateX(-50%) translateY(0);}

/* === HEADER === */
.home-header{position:relative;z-index:10;text-align:center;padding:50px 20px 30px;border-bottom:1px solid rgba(201,168,76,.15);}
.moon-icon{font-size:2.8rem;display:block;margin-bottom:10px;animation:float 4s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.arabic-title{font-family:'Amiri',serif;font-size:clamp(1.5rem,4vw,2.4rem);color:var(--gold-light);letter-spacing:.05em;line-height:1.3;margin-bottom:6px;direction:rtl;}
.home-header h1{font-family:'Cinzel',serif;font-size:clamp(1.2rem,3vw,1.8rem);color:var(--white);letter-spacing:.15em;font-weight:600;margin-bottom:4px;text-transform:uppercase;}
.home-subtitle{color:var(--gold);font-size:.85rem;font-weight:300;letter-spacing:.3em;text-transform:uppercase;margin-bottom:20px;}

.progress-section{display:flex;align-items:center;justify-content:center;gap:14px;margin-top:16px;flex-wrap:wrap;}
.progress-label{font-family:'Cinzel',serif;font-size:.8rem;color:var(--gold);letter-spacing:.1em;white-space:nowrap;}
.progress-bar-wrap{width:200px;height:5px;background:rgba(201,168,76,.15);border-radius:99px;overflow:hidden;}
.progress-bar-fill{height:100%;background:linear-gradient(90deg,var(--gold-dim),var(--gold-light));border-radius:99px;transition:width .5s;width:0%;}
.progress-count{font-family:'Cinzel',serif;font-size:.8rem;color:var(--gold-light);font-weight:600;}

/* === TABS === */
.tabs{position:relative;z-index:10;display:flex;justify-content:center;gap:0;padding:16px 20px 0;background:linear-gradient(180deg,rgba(201,168,76,.04),transparent);}
.tab-btn{background:none;border:none;color:var(--text-dim);font-family:'Cinzel',serif;font-size:.78rem;letter-spacing:.1em;text-transform:uppercase;padding:10px 22px;border-bottom:2px solid transparent;transition:all .3s;}
.tab-btn.active{color:var(--gold-light);border-bottom-color:var(--gold);}
.tab-btn:hover{color:var(--gold);}

/* === JUZ GRID === */
.grid-section{position:relative;z-index:10;max-width:1100px;margin:0 auto;padding:30px 20px 60px;}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:14px;}

.juz-card{position:relative;background:var(--card);border:1px solid rgba(201,168,76,.12);border-radius:var(--radius);padding:20px 14px 40px;text-align:center;cursor:pointer;transition:all .3s;overflow:hidden;animation:fadeUp .4s ease both;}
.juz-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--gold-dim),transparent);opacity:0;transition:opacity .3s;}
.juz-card:hover{background:var(--card-hover);border-color:rgba(201,168,76,.35);transform:translateY(-3px);box-shadow:0 12px 32px rgba(0,0,0,.4);}
.juz-card:hover::before{opacity:1;}
.juz-card.completed{background:var(--completed);border-color:var(--completed-border);}
.juz-card.completed::after{content:'‚úì';position:absolute;top:8px;right:10px;color:var(--green);font-size:.9rem;font-weight:700;}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

.juz-arabic{font-family:'Amiri',serif;font-size:1rem;color:var(--gold-light);display:block;margin-bottom:4px;direction:rtl;}
.juz-label{font-family:'Cinzel',serif;font-size:.6rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.2em;display:block;margin-bottom:6px;}
.juz-number{font-family:'Cinzel',serif;font-size:2rem;font-weight:700;color:var(--white);line-height:1;display:block;margin-bottom:10px;}
.listen-badge{display:inline-flex;align-items:center;gap:5px;background:linear-gradient(135deg,rgba(201,168,76,.18),rgba(201,168,76,.06));border:1px solid rgba(201,168,76,.25);color:var(--gold);font-size:.65rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;padding:5px 10px;border-radius:99px;}
.juz-card:hover .listen-badge{background:linear-gradient(135deg,rgba(201,168,76,.3),rgba(201,168,76,.12));border-color:var(--gold);}

.mark-btn{position:absolute;bottom:0;left:0;right:0;background:rgba(74,222,128,.06);border:none;border-top:1px solid rgba(74,222,128,.12);color:var(--green);font-size:.6rem;letter-spacing:.08em;text-transform:uppercase;padding:6px;transition:background .2s;border-radius:0 0 var(--radius) var(--radius);}
.mark-btn:hover{background:rgba(74,222,128,.14);}
.juz-card.completed .mark-btn{background:rgba(74,222,128,.1);color:#86efac;}

/* === SURAH LIST === */
.surah-container{display:none;max-width:700px;margin:0 auto;padding:0 20px 60px;}
.surah-container.active{display:block;}
.search-wrap{padding:0 0 16px;position:relative;}
.search-input{width:100%;background:var(--card);border:1px solid rgba(201,168,76,.2);border-radius:12px;padding:12px 16px 12px 42px;color:var(--white);font-size:.95rem;outline:none;transition:border-color .3s;}
.search-input:focus{border-color:var(--gold);}
.search-input::placeholder{color:var(--text-dim);}
.search-icon{position:absolute;left:14px;top:12px;font-size:1.1rem;color:var(--text-dim);}

.surah-item{display:flex;align-items:center;gap:14px;padding:14px 16px;background:var(--card);border:1px solid rgba(201,168,76,.08);border-radius:12px;margin-bottom:8px;cursor:pointer;transition:all .2s;}
.surah-item:hover{background:var(--card-hover);border-color:rgba(201,168,76,.25);transform:translateX(4px);}
.surah-num{width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.25);border-radius:10px;font-family:'Cinzel',serif;font-size:.85rem;color:var(--gold);font-weight:600;flex-shrink:0;}
.surah-info{flex:1;min-width:0;}
.surah-name-ar{font-family:'Amiri',serif;font-size:1.15rem;color:var(--gold-light);direction:rtl;text-align:right;}
.surah-name-en{font-size:.78rem;color:var(--text-dim);margin-top:2px;}
.surah-meta{text-align:right;flex-shrink:0;}
.surah-ayah-count{font-size:.7rem;color:var(--text-dim);}
.surah-type{font-size:.6rem;color:var(--teal-light);text-transform:uppercase;letter-spacing:.08em;margin-top:2px;}

/* === READER === */
.reader-header{position:sticky;top:0;z-index:100;background:rgba(15,21,32,.97);border-bottom:1px solid rgba(201,168,76,.2);display:flex;align-items:center;padding:12px 16px;gap:10px;backdrop-filter:blur(12px);}
.back-btn{background:rgba(201,168,76,.15);border:1px solid rgba(201,168,76,.3);color:var(--gold-light);font-size:.85rem;padding:10px 18px;border-radius:10px;display:flex;align-items:center;gap:8px;transition:all .2s;flex-shrink:0;font-weight:600;}
.back-btn:hover{border-color:var(--gold);background:rgba(201,168,76,.25);}
.reader-title-area{flex:1;text-align:center;overflow:hidden;min-width:0;}
.reader-title{font-family:'Amiri',serif;font-size:1.2rem;color:var(--gold-light);direction:rtl;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.reader-subtitle{font-size:.65rem;color:var(--text-dim);letter-spacing:.08em;margin-top:2px;}
.reader-actions{display:flex;gap:6px;flex-shrink:0;}
.reader-actions button{background:rgba(201,168,76,.08);border:1px solid rgba(201,168,76,.15);color:var(--gold);width:38px;height:38px;border-radius:10px;font-size:1rem;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.reader-actions button:hover{border-color:var(--gold);background:rgba(201,168,76,.15);}
.reader-actions button.on{background:rgba(201,168,76,.25);border-color:var(--gold);}

/* Surah navigation in reader */
.surah-nav{display:flex;justify-content:center;gap:10px;padding:16px;max-width:800px;margin:0 auto;}
.surah-nav-btn{background:var(--card);border:1px solid rgba(201,168,76,.2);color:var(--gold);padding:10px 20px;border-radius:10px;font-size:.8rem;font-family:'Cinzel',serif;letter-spacing:.08em;transition:all .2s;display:flex;align-items:center;gap:6px;}
.surah-nav-btn:hover{background:var(--card-hover);border-color:var(--gold);}
.surah-nav-btn:disabled{opacity:.3;cursor:not-allowed;}

.reader-content{max-width:800px;margin:0 auto;padding:0 16px 200px;min-height:80vh;}

/* Error */
.error-box{text-align:center;padding:60px 20px;color:var(--text-dim);}
.error-box .err-icon{font-size:3rem;display:block;margin-bottom:16px;}
.error-box h3{color:#e74c3c;font-family:'Cinzel',serif;margin-bottom:8px;font-size:1.1rem;}
.error-box p{margin-bottom:20px;font-size:.9rem;}
.retry-btn{background:var(--gold);color:var(--night);border:none;padding:12px 30px;border-radius:10px;font-size:.9rem;font-weight:700;font-family:'Cinzel',serif;letter-spacing:.08em;transition:filter .2s;}
.retry-btn:hover{filter:brightness(1.1);}

/* Surah Banner */
.surah-banner{text-align:center;padding:28px 20px;margin:16px 0 20px;background:linear-gradient(180deg,rgba(201,168,76,.08),rgba(201,168,76,.02));border:1px solid rgba(201,168,76,.2);border-radius:var(--radius);position:relative;}
.surah-banner::before,.surah-banner::after{content:'‚ú¶';position:absolute;top:50%;color:rgba(201,168,76,.3);font-size:.8rem;}
.surah-banner::before{left:16px;transform:translateY(-50%);}
.surah-banner::after{right:16px;transform:translateY(-50%);}
.surah-banner-name{font-family:'Amiri',serif;font-size:1.8rem;color:var(--gold-light);direction:rtl;margin-bottom:6px;}
.surah-banner-en{font-family:'Cinzel',serif;font-size:.85rem;color:var(--white);margin-bottom:4px;letter-spacing:.1em;}
.surah-banner-detail{font-size:.72rem;color:var(--text-dim);letter-spacing:.1em;}

.bismillah{text-align:center;font-family:'Amiri',serif;font-size:1.5rem;color:var(--gold);direction:rtl;padding:12px 0 20px;opacity:.9;}

/* Verses */
.verse{padding:16px 14px;border-bottom:1px solid rgba(201,168,76,.06);transition:background .3s;cursor:pointer;border-radius:8px;margin-bottom:2px;}
.verse:hover{background:rgba(201,168,76,.04);}
.verse.playing{background:rgba(201,168,76,.1);border-left:3px solid var(--gold);border-radius:0 8px 8px 0;}
.verse-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.verse-num-badge{display:inline-flex;align-items:center;justify-content:center;min-width:34px;height:34px;padding:0 8px;background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.2);border-radius:50%;font-family:'Amiri',serif;font-size:.85rem;color:var(--gold);}
.verse-play-btn{background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.2);color:var(--gold);font-size:.75rem;padding:6px 12px;border-radius:20px;transition:all .2s;display:flex;align-items:center;gap:4px;}
.verse-play-btn:hover{background:rgba(201,168,76,.2);border-color:var(--gold);}
.verse-play-btn.active-v{background:var(--gold);color:var(--night);border-color:var(--gold);}
.verse-arabic{font-family:'Amiri',serif;font-size:clamp(1.3rem,3.5vw,1.7rem);line-height:2.4;color:var(--white);text-align:right;direction:rtl;margin-bottom:10px;word-spacing:4px;}
.verse-translation{font-size:.88rem;color:var(--text-dim);line-height:1.7;padding-left:14px;border-left:2px solid rgba(201,168,76,.15);margin-top:8px;}

/* === AUDIO PLAYER === */
.audio-player{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(180deg,rgba(15,21,32,.98),#080b11);border-top:1px solid rgba(201,168,76,.25);padding:8px 16px 14px;z-index:200;display:none;backdrop-filter:blur(12px);}
.audio-player.show{display:block;}

.player-progress{width:100%;height:4px;background:rgba(201,168,76,.15);border-radius:99px;margin-bottom:8px;cursor:pointer;}
.player-progress-fill{height:100%;background:linear-gradient(90deg,var(--gold-dim),var(--gold));border-radius:99px;transition:width .2s;width:0%;}

.player-main{display:flex;align-items:center;gap:10px;}
.player-info{flex:1;min-width:0;}
.player-surah-name{font-family:'Amiri',serif;color:var(--gold-light);font-size:.9rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.player-ayah-num{color:var(--text-dim);font-size:.68rem;margin-top:2px;}
.player-controls{display:flex;align-items:center;gap:2px;}
.player-controls button{background:none;border:none;color:var(--gold);font-size:1.1rem;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .2s;}
.player-controls button:hover{background:rgba(201,168,76,.12);}
.play-main{background:linear-gradient(135deg,var(--gold-dim),var(--gold))!important;color:var(--night)!important;width:46px!important;height:46px!important;font-size:1.3rem!important;}
.play-main:hover{filter:brightness(1.15);}
.player-extra{display:flex;align-items:center;gap:2px;}
.player-extra button{background:none;border:none;color:var(--text-dim);font-size:.85rem;width:34px;height:34px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .2s;}
.player-extra button:hover{color:var(--gold);}
.player-extra button.on{color:var(--gold);}

/* === SETTINGS === */
.settings-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:300;display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px);}
.settings-overlay.show{display:flex;}
.settings-panel{background:var(--deep);border:1px solid rgba(201,168,76,.2);border-radius:24px 24px 0 0;padding:24px 20px 40px;width:100%;max-width:500px;animation:slideUp .3s ease;}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.settings-handle{width:40px;height:4px;background:rgba(201,168,76,.3);border-radius:99px;margin:0 auto 20px;}
.settings-title{font-family:'Cinzel',serif;font-size:1.1rem;color:var(--gold-light);text-align:center;margin-bottom:20px;letter-spacing:.1em;}
.setting-group{margin-bottom:18px;}
.setting-label{font-size:.75rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px;display:block;}
.setting-select{width:100%;background:var(--card);border:1px solid rgba(201,168,76,.2);border-radius:10px;padding:12px 14px;color:var(--white);font-size:.9rem;outline:none;appearance:none;cursor:pointer;}
.setting-select:focus{border-color:var(--gold);}
.setting-select option{background:var(--deep);color:var(--white);}
.reciter-test{display:inline-block;margin-top:8px;background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.2);color:var(--gold);padding:6px 14px;border-radius:8px;font-size:.75rem;transition:all .2s;}
.reciter-test:hover{background:rgba(201,168,76,.2);}
.settings-close{display:block;width:100%;background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.25);color:var(--gold);font-family:'Cinzel',serif;font-size:.85rem;padding:12px;border-radius:12px;margin-top:16px;letter-spacing:.1em;transition:all .2s;}
.settings-close:hover{background:rgba(201,168,76,.2);}

/* === FOOTER === */
footer{position:relative;z-index:10;text-align:center;padding:24px 20px 36px;border-top:1px solid rgba(201,168,76,.08);}
.footer-dua{font-family:'Amiri',serif;font-size:1rem;color:var(--gold);direction:rtl;margin-bottom:10px;line-height:1.8;}
.footer-credit{font-size:.75rem;color:var(--text-dim);}
.footer-credit a{color:var(--teal-light);}
.footer-credit a:hover{color:var(--gold);}

/* === RESPONSIVE === */
@media(max-width:480px){
  .grid{grid-template-columns:repeat(3,1fr);gap:10px;}
  .juz-number{font-size:1.5rem;}
  .juz-arabic{font-size:.82rem;}
  .listen-badge{font-size:.55rem;padding:4px 7px;}
  .verse-arabic{font-size:1.2rem;line-height:2.1;}
  .reader-header{padding:10px 10px;gap:6px;}
  .back-btn{padding:8px 12px;font-size:.78rem;}
  .player-main{gap:6px;}
  .surah-banner-name{font-size:1.4rem;}
  .tab-btn{padding:10px 14px;font-size:.7rem;}
  .surah-nav-btn{padding:8px 14px;font-size:.7rem;}
  .home-header{padding:35px 16px 24px;}
}
</style>
</head>
<body>

<div class="bg-glow"></div>
<div class="bg-pattern">
  <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid slice">
    <defs><pattern id="geo" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse">
      <polygon points="20,2 38,11 38,29 20,38 2,29 2,11" fill="none" stroke="#c9a84c" stroke-width="0.5"/>
      <polygon points="20,8 32,14 32,26 20,32 8,26 8,14" fill="none" stroke="#c9a84c" stroke-width="0.3"/>
    </pattern></defs>
    <rect width="200" height="200" fill="url(#geo)"/>
  </svg>
</div>

<!-- Loading -->
<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <div class="loading-text" id="loading-msg">ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÇÿ±ÿ¢ŸÜ ÿßŸÑŸÉÿ±ŸäŸÖ...</div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- ============================== -->
<!-- VIEW: HOME                     -->
<!-- ============================== -->
<div class="view active" id="view-home">
  <header class="home-header">
    <span class="moon-icon">üåô</span>
    <div class="arabic-title">ÿßŸÑŸÇÿ±ÿ¢ŸÜ ÿßŸÑŸÉÿ±ŸäŸÖ</div>
    <h1>Al-Quran Al-Karim</h1>
    <div class="home-subtitle">Le Noble Coran</div>
    <div class="progress-section">
      <span class="progress-label">Progression</span>
      <div class="progress-bar-wrap">
        <div class="progress-bar-fill" id="progressFill"></div>
      </div>
      <span class="progress-count" id="progressCount">0 / 30</span>
    </div>
  </header>

  <div class="tabs">
    <button class="tab-btn active" id="tab-juz" onclick="switchTab('juz')">üìñ Par Juz</button>
    <button class="tab-btn" id="tab-surah" onclick="switchTab('surah')">üìã Par Sourate</button>
  </div>

  <div class="grid-section" id="juz-section">
    <div class="grid" id="juz-grid"></div>
  </div>

  <div class="surah-container" id="surah-section">
    <div class="search-wrap">
      <span class="search-icon">üîç</span>
      <input class="search-input" type="text" placeholder="Rechercher une sourate... (nom ou num√©ro)" oninput="filterSurahs(this.value)"/>
    </div>
    <div id="surah-list"></div>
  </div>

  <footer>
    <div class="footer-dua">ÿßŸÑŸÑŸéŸëŸáŸèŸÖŸéŸë ÿßÿ¨ŸíÿπŸéŸÑŸê ÿßŸÑŸíŸÇŸèÿ±Ÿíÿ¢ŸÜŸé ÿ±Ÿéÿ®ŸêŸäÿπŸé ŸÇŸéŸÑŸíÿ®ŸêŸä ü§≤</div>
    <div class="footer-credit">
      Made with ‚ù§Ô∏è by <a href="https://github.com/" target="_blank">Mouhamadou</a> ¬∑ Open Source
    </div>
  </footer>
</div>

<!-- ============================== -->
<!-- VIEW: READER                   -->
<!-- ============================== -->
<div class="view" id="view-reader">
  <div class="reader-header">
    <button class="back-btn" onclick="goHome()">‚Üê Retour</button>
    <div class="reader-title-area">
      <div class="reader-title" id="reader-title">ÿßŸÑŸÇÿ±ÿ¢ŸÜ ÿßŸÑŸÉÿ±ŸäŸÖ</div>
      <div class="reader-subtitle" id="reader-subtitle"></div>
    </div>
    <div class="reader-actions">
      <button onclick="toggleTranslation()" id="btn-trans" class="on" title="Afficher/masquer traduction">üåç</button>
      <button onclick="openSettings()" title="Param√®tres">‚öôÔ∏è</button>
    </div>
  </div>

  <div id="reader-nav-top"></div>
  <div class="reader-content" id="reader-content"></div>
  <div id="reader-nav-bottom"></div>
</div>

<!-- ============================== -->
<!-- AUDIO PLAYER                   -->
<!-- ============================== -->
<div class="audio-player" id="audio-player">
  <div class="player-progress" id="player-progress" onclick="seekAudio(event)">
    <div class="player-progress-fill" id="player-progress-fill"></div>
  </div>
  <div class="player-main">
    <div class="player-info">
      <div class="player-surah-name" id="player-surah">‚Äî</div>
      <div class="player-ayah-num" id="player-ayah">‚Äî</div>
    </div>
    <div class="player-controls">
      <button onclick="prevAyah()" title="Verset pr√©c√©dent">‚èÆ</button>
      <button class="play-main" onclick="togglePlay()" id="play-btn" title="Lecture / Pause">‚ñ∂</button>
      <button onclick="nextAyah()" title="Verset suivant">‚è≠</button>
    </div>
    <div class="player-extra">
      <button onclick="toggleRepeat()" id="btn-repeat" title="R√©p√©ter le verset">üîÅ</button>
      <button onclick="toggleAutoplay()" id="btn-autoplay" class="on" title="Lecture automatique">‚è©</button>
    </div>
  </div>
</div>

<!-- ============================== -->
<!-- SETTINGS                       -->
<!-- ============================== -->
<div class="settings-overlay" id="settings-overlay" onclick="if(event.target===this)closeSettings()">
  <div class="settings-panel">
    <div class="settings-handle"></div>
    <div class="settings-title">‚öôÔ∏è Param√®tres</div>

    <div class="setting-group">
      <label class="setting-label">üéôÔ∏è R√©citateur</label>
      <select class="setting-select" id="select-reciter" onchange="changeReciter(this.value)">
        <option value="ar.alafasy">Mishary Rashid Alafasy</option>
        <option value="ar.abdulbasitmurattal">Abdul Basit (Murattal)</option>
        <option value="ar.abdurrahmaansudais">Abdurrahman As-Sudais</option>
        <option value="ar.husary">Mahmoud Khalil Al-Husary</option>
        <option value="ar.minshawimujawwad">El-Minshawi (Mujawwad)</option>
        <option value="ar.muhammadayyoub">Muhammad Ayyoub</option>
        <option value="ar.muhammadjibreel">Muhammad Jibreel</option>
        <option value="ar.hudhaify">Ali Al-Hudhaify</option>
      </select>
      <button class="reciter-test" onclick="testReciter()">üîä Tester le r√©citateur</button>
    </div>

    <div class="setting-group">
      <label class="setting-label">üåç Traduction</label>
      <select class="setting-select" id="select-translation" onchange="changeTranslation(this.value)">
        <option value="fr.hamidullah">üá´üá∑ Fran√ßais ‚Äî Hamidullah</option>
        <option value="en.sahih">üá¨üáß English ‚Äî Sahih International</option>
        <option value="en.pickthall">üá¨üáß English ‚Äî Pickthall</option>
        <option value="tr.ates">üáπüá∑ T√ºrk√ße ‚Äî S√ºleyman Ate≈ü</option>
      </select>
    </div>

    <button class="settings-close" onclick="closeSettings()">‚úì Fermer</button>
  </div>
</div>

<!-- Hidden audio -->
<audio id="quran-audio" preload="auto"></audio>

<script>
/* ================================================
   STATE
   ================================================ */
const S = {
  view: 'home',
  type: null,           // 'juz' | 'surah'
  num: null,
  ayahs: [],
  trans: [],
  idx: 0,
  playing: false,
  repeat: false,
  autoplay: true,
  showTrans: true,
  reciter: localStorage.getItem('q_rec') || 'ar.alafasy',
  edition: localStorage.getItem('q_tr') || 'fr.hamidullah',
  done: JSON.parse(localStorage.getItem('q_done') || '[]'),
  surahList: null,
  cache: {}
};

const API = 'https://api.alquran.cloud/v1';
const CDN = 'https://cdn.islamic.network/quran/audio/128';
const audio = document.getElementById('quran-audio');

const JUZ_AR = [
  'ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ£ŸàŸÑ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ´ÿßŸÜŸä','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ´ÿßŸÑÿ´','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ±ÿßÿ®ÿπ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿÆÿßŸÖÿ≥',
  'ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ≥ÿßÿØÿ≥','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ≥ÿßÿ®ÿπ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ´ÿßŸÖŸÜ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ™ÿßÿ≥ÿπ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿπÿßÿ¥ÿ±',
  'ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ≠ÿßÿØŸä ÿπÿ¥ÿ±','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ´ÿßŸÜŸä ÿπÿ¥ÿ±','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ´ÿßŸÑÿ´ ÿπÿ¥ÿ±','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ±ÿßÿ®ÿπ ÿπÿ¥ÿ±','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿÆÿßŸÖÿ≥ ÿπÿ¥ÿ±',
  'ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ≥ÿßÿØÿ≥ ÿπÿ¥ÿ±','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ≥ÿßÿ®ÿπ ÿπÿ¥ÿ±','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ´ÿßŸÖŸÜ ÿπÿ¥ÿ±','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ™ÿßÿ≥ÿπ ÿπÿ¥ÿ±','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿπÿ¥ÿ±ŸàŸÜ',
  'ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ≠ÿßÿØŸä ŸàÿßŸÑÿπÿ¥ÿ±ŸàŸÜ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ´ÿßŸÜŸä ŸàÿßŸÑÿπÿ¥ÿ±ŸàŸÜ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ´ÿßŸÑÿ´ ŸàÿßŸÑÿπÿ¥ÿ±ŸàŸÜ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ±ÿßÿ®ÿπ ŸàÿßŸÑÿπÿ¥ÿ±ŸàŸÜ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿÆÿßŸÖÿ≥ ŸàÿßŸÑÿπÿ¥ÿ±ŸàŸÜ',
  'ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ≥ÿßÿØÿ≥ ŸàÿßŸÑÿπÿ¥ÿ±ŸàŸÜ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ≥ÿßÿ®ÿπ ŸàÿßŸÑÿπÿ¥ÿ±ŸàŸÜ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ´ÿßŸÖŸÜ ŸàÿßŸÑÿπÿ¥ÿ±ŸàŸÜ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ™ÿßÿ≥ÿπ ŸàÿßŸÑÿπÿ¥ÿ±ŸàŸÜ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ´ŸÑÿßÿ´ŸàŸÜ'
];

/* ================================================
   UTILS
   ================================================ */
function toAr(n) {
  const d = 'Ÿ†Ÿ°Ÿ¢Ÿ£Ÿ§Ÿ•Ÿ¶ŸßŸ®Ÿ©';
  return String(n).split('').map(c => d[+c] || c).join('');
}

function showLoading(msg) {
  document.getElementById('loading-msg').textContent = msg || 'ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÇÿ±ÿ¢ŸÜ ÿßŸÑŸÉÿ±ŸäŸÖ...';
  document.getElementById('loading').classList.add('show');
}
function hideLoading() {
  document.getElementById('loading').classList.remove('show');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

function showView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById('view-' + name).classList.add('active');
  S.view = name;
  window.scrollTo(0, 0);
}

/* ================================================
   PROGRESS / COMPLETION
   ================================================ */
function saveDone() {
  localStorage.setItem('q_done', JSON.stringify(S.done));
  updateProgress();
}
function updateProgress() {
  const n = S.done.length;
  document.getElementById('progressFill').style.width = (n / 30 * 100) + '%';
  document.getElementById('progressCount').textContent = n + ' / 30';
}
function toggleDone(num, e) {
  e.stopPropagation();
  const i = S.done.indexOf(num);
  if (i === -1) { S.done.push(num); showToast('‚úì Juz ' + num + ' marqu√© comme lu'); }
  else { S.done.splice(i, 1); }
  saveDone();
  renderJuzGrid();
}

/* ================================================
   API
   ================================================ */
async function apiFetch(endpoint) {
  const res = await fetch(API + endpoint);
  if (!res.ok) throw new Error('HTTP ' + res.status);
  const json = await res.json();
  if (json.code !== 200) throw new Error('API ' + json.code);
  return json.data;
}

/* === LOAD JUZ (already works) === */
async function loadJuz(num) {
  const key = 'juz_' + num + '_' + S.edition;
  if (S.cache[key]) return S.cache[key];
  showLoading('ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ¨ÿ≤ÿ° ' + toAr(num) + '...');
  try {
    const [ar, tr] = await Promise.all([
      apiFetch('/juz/' + num + '/quran-uthmani'),
      apiFetch('/juz/' + num + '/' + S.edition)
    ]);
    // Juz endpoint: each ayah already has surah object ‚úÖ
    const result = { ayahs: ar.ayahs, trans: tr.ayahs };
    S.cache[key] = result;
    return result;
  } finally { hideLoading(); }
}

/* === LOAD SURAH (THE FIX!) === */
async function loadSurah(num) {
  const key = 'surah_' + num + '_' + S.edition;
  if (S.cache[key]) return S.cache[key];
  showLoading('ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥Ÿàÿ±ÿ©...');
  try {
    const [ar, tr] = await Promise.all([
      apiFetch('/surah/' + num + '/quran-uthmani'),
      apiFetch('/surah/' + num + '/' + S.edition)
    ]);

    /* ============================================
       üîß FIX PRINCIPAL !
       L'API /surah/ ne met PAS l'objet "surah" dans chaque ayah
       Il faut l'injecter nous-m√™mes !
       ============================================ */
    const surahInfo = {
      number: ar.number,
      name: ar.name,
      englishName: ar.englishName,
      englishNameTranslation: ar.englishNameTranslation,
      numberOfAyahs: ar.numberOfAyahs,
      revelationType: ar.revelationType
    };

    // Injecter surah dans chaque ayah
    ar.ayahs.forEach(function(ayah) {
      ayah.surah = surahInfo;
    });
    tr.ayahs.forEach(function(ayah) {
      ayah.surah = surahInfo;
    });

    const result = { ayahs: ar.ayahs, trans: tr.ayahs };
    S.cache[key] = result;
    return result;
  } finally { hideLoading(); }
}

/* === LOAD SURAH LIST === */
async function loadSurahList() {
  if (S.surahList) return S.surahList;
  const data = await apiFetch('/surah');
  S.surahList = data;
  return data;
}

/* ================================================
   NAVIGATION
   ================================================ */
function goHome() {
  audio.pause();
  S.playing = false;
  showView('home');
  document.getElementById('audio-player').classList.remove('show');
  updatePlayBtn();
}

async function openJuz(num) {
  showView('reader');
  S.type = 'juz';
  S.num = num;
  document.getElementById('reader-title').textContent = JUZ_AR[num - 1];
  document.getElementById('reader-subtitle').textContent = 'Juz ' + num + ' / 30';
  document.getElementById('reader-content').innerHTML = loadingHTML();
  clearNav();

  try {
    const data = await loadJuz(num);
    S.ayahs = data.ayahs;
    S.trans = data.trans;
    S.idx = 0;
    renderVerses();
    renderJuzNav(num);
  } catch (err) {
    console.error(err);
    document.getElementById('reader-content').innerHTML = errorHTML('openJuz(' + num + ')');
  }
}

async function openSurah(num) {
  showView('reader');
  S.type = 'surah';
  S.num = num;
  document.getElementById('reader-content').innerHTML = loadingHTML();
  document.getElementById('reader-subtitle').textContent = 'Sourate ' + num + ' / 114';
  clearNav();

  try {
    const data = await loadSurah(num);
    S.ayahs = data.ayahs;
    S.trans = data.trans;
    S.idx = 0;
    document.getElementById('reader-title').textContent = data.ayahs[0].surah.name;
    renderVerses();
    renderSurahNav(num);
  } catch (err) {
    console.error(err);
    document.getElementById('reader-content').innerHTML = errorHTML('openSurah(' + num + ')');
  }
}

function loadingHTML() {
  return '<div style="text-align:center;padding:80px 20px;color:var(--text-dim)">' +
    '<div class="spinner" style="margin:0 auto 20px"></div>' +
    '<div style="font-family:Amiri,serif;font-size:1.2rem;color:var(--gold)">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>' +
    '<div style="margin-top:8px;font-size:.8rem">Chargement en cours...</div></div>';
}

function errorHTML(retryFn) {
  return '<div class="error-box">' +
    '<span class="err-icon">‚ùå</span>' +
    '<h3>Erreur de chargement</h3>' +
    '<p>V√©rifiez votre connexion internet et r√©essayez</p>' +
    '<button class="retry-btn" onclick="' + retryFn + '">üîÑ R√©essayer</button></div>';
}

function clearNav() {
  document.getElementById('reader-nav-top').innerHTML = '';
  document.getElementById('reader-nav-bottom').innerHTML = '';
}

/* === Surah nav buttons === */
function renderSurahNav(num) {
  const html =
    '<div class="surah-nav">' +
      '<button class="surah-nav-btn" onclick="openSurah(' + (num - 1) + ')"' + (num <= 1 ? ' disabled' : '') + '>‚Üê Sourate pr√©c√©dente</button>' +
      '<button class="surah-nav-btn" onclick="openSurah(' + (num + 1) + ')"' + (num >= 114 ? ' disabled' : '') + '>Sourate suivante ‚Üí</button>' +
    '</div>';
  document.getElementById('reader-nav-top').innerHTML = '';
  document.getElementById('reader-nav-bottom').innerHTML = html;
}

function renderJuzNav(num) {
  const html =
    '<div class="surah-nav">' +
      '<button class="surah-nav-btn" onclick="openJuz(' + (num - 1) + ')"' + (num <= 1 ? ' disabled' : '') + '>‚Üê Juz pr√©c√©dent</button>' +
      '<button class="surah-nav-btn" onclick="openJuz(' + (num + 1) + ')"' + (num >= 30 ? ' disabled' : '') + '>Juz suivant ‚Üí</button>' +
    '</div>';
  document.getElementById('reader-nav-top').innerHTML = '';
  document.getElementById('reader-nav-bottom').innerHTML = html;
}

/* ================================================
   RENDER: JUZ GRID
   ================================================ */
function renderJuzGrid() {
  const grid = document.getElementById('juz-grid');
  grid.innerHTML = '';
  for (let i = 1; i <= 30; i++) {
    const done = S.done.includes(i);
    const card = document.createElement('div');
    card.className = 'juz-card' + (done ? ' completed' : '');
    card.style.animationDelay = (Math.min(i, 15) * 0.03) + 's';
    card.innerHTML =
      '<span class="juz-arabic">' + JUZ_AR[i - 1].split(' ').slice(0, 2).join(' ') + '</span>' +
      '<span class="juz-label">Juz</span>' +
      '<span class="juz-number">' + String(i).padStart(2, '0') + '</span>' +
      '<span class="listen-badge">üìñ Lire & √âcouter</span>' +
      '<button class="mark-btn" onclick="toggleDone(' + i + ',event)">' +
      (done ? '‚úì Termin√©' : '+ Marquer lu') + '</button>';
    card.addEventListener('click', function() { openJuz(i); });
    grid.appendChild(card);
  }
  updateProgress();
}

/* ================================================
   RENDER: SURAH LIST
   ================================================ */
let surahListRendered = false;
async function renderSurahList() {
  if (surahListRendered) return;
  const container = document.getElementById('surah-list');
  container.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-dim)"><div class="spinner" style="margin:0 auto 12px"></div>Chargement des 114 sourates...</div>';

  try {
    const surahs = await loadSurahList();
    container.innerHTML = '';
    surahs.forEach(function(s) {
      const item = document.createElement('div');
      item.className = 'surah-item';
      item.dataset.search = (s.name + ' ' + s.englishName + ' ' + s.englishNameTranslation + ' ' + s.number).toLowerCase();
      item.innerHTML =
        '<div class="surah-num">' + s.number + '</div>' +
        '<div class="surah-info">' +
          '<div class="surah-name-ar">' + s.name + '</div>' +
          '<div class="surah-name-en">' + s.englishName + ' ‚Äî ' + s.englishNameTranslation + '</div>' +
        '</div>' +
        '<div class="surah-meta">' +
          '<div class="surah-ayah-count">' + s.numberOfAyahs + ' versets</div>' +
          '<div class="surah-type">' + (s.revelationType === 'Meccan' ? 'üïã Mecquoise' : 'üïå M√©dinoise') + '</div>' +
        '</div>';
      item.addEventListener('click', function() { openSurah(s.number); });
      container.appendChild(item);
    });
    surahListRendered = true;
  } catch (err) {
    container.innerHTML = '<div style="text-align:center;padding:30px;color:#e74c3c;">‚ùå Erreur ‚Äî <button onclick="surahListRendered=false;renderSurahList()" style="color:var(--gold);background:none;border:1px solid var(--gold);padding:6px 16px;border-radius:8px;margin-top:8px;">R√©essayer</button></div>';
  }
}

function filterSurahs(q) {
  q = q.toLowerCase().trim();
  document.querySelectorAll('.surah-item').forEach(function(item) {
    item.style.display = (!q || item.dataset.search.includes(q)) ? '' : 'none';
  });
}

/* ================================================
   RENDER: VERSES
   ================================================ */
function renderVerses() {
  const content = document.getElementById('reader-content');
  content.innerHTML = '';
  let curSurah = null;

  S.ayahs.forEach(function(ayah, idx) {
    // Surah banner
    if (!curSurah || ayah.surah.number !== curSurah) {
      curSurah = ayah.surah.number;
      const banner = document.createElement('div');
      banner.className = 'surah-banner';
      banner.innerHTML =
        '<div class="surah-banner-name">' + ayah.surah.name + '</div>' +
        '<div class="surah-banner-en">' + ayah.surah.englishName + '</div>' +
        '<div class="surah-banner-detail">' + ayah.surah.englishNameTranslation + ' ‚Ä¢ ' +
        ayah.surah.numberOfAyahs + ' versets ‚Ä¢ ' +
        (ayah.surah.revelationType === 'Meccan' ? 'üïã Mecquoise' : 'üïå M√©dinoise') + '</div>';
      content.appendChild(banner);

      // Bismillah
      if (ayah.surah.number !== 9 && ayah.surah.number !== 1) {
        const bis = document.createElement('div');
        bis.className = 'bismillah';
        bis.textContent = 'ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸáŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê';
        content.appendChild(bis);
      }
    }

    // Verse
    const v = document.createElement('div');
    v.className = 'verse';
    v.id = 'v-' + idx;

    let html =
      '<div class="verse-head">' +
        '<span class="verse-num-badge">' + toAr(ayah.numberInSurah) + '</span>' +
        '<button class="verse-play-btn" id="vb-' + idx + '" onclick="event.stopPropagation();playAyah(' + idx + ')">‚ñ∂ √âcouter</button>' +
      '</div>' +
      '<div class="verse-arabic">' + ayah.text + ' Ô¥ø' + toAr(ayah.numberInSurah) + 'Ô¥æ</div>';

    if (S.showTrans && S.trans[idx]) {
      html += '<div class="verse-translation">' + S.trans[idx].text + '</div>';
    }

    v.innerHTML = html;
    v.addEventListener('click', function() { playAyah(idx); });
    content.appendChild(v);
  });

  // Spacer
  const sp = document.createElement('div');
  sp.style.height = '130px';
  content.appendChild(sp);

  // Show player
  document.getElementById('audio-player').classList.add('show');
}

/* ================================================
   AUDIO PLAYER
   ================================================ */
function audioUrl(ayahNum) {
  return CDN + '/' + S.reciter + '/' + ayahNum + '.mp3';
}

function playAyah(idx) {
  if (idx < 0 || idx >= S.ayahs.length) return;
  S.idx = idx;
  const ayah = S.ayahs[idx];
  const url = audioUrl(ayah.number);

  audio.src = url;
  audio.play().then(function() {
    S.playing = true;
    updatePlayBtn();
  }).catch(function(err) {
    console.error('Audio error:', err);
    showToast('‚ö†Ô∏è Erreur audio ‚Äî essayez un autre r√©citateur');
  });

  highlightVerse(idx);
  updatePlayerInfo();
  document.getElementById('audio-player').classList.add('show');
}

function togglePlay() {
  if (!S.ayahs.length) return;
  if (S.playing) {
    audio.pause();
    S.playing = false;
  } else {
    if (!audio.src || audio.src === location.href) {
      playAyah(0);
      return;
    }
    audio.play().catch(function() {});
    S.playing = true;
  }
  updatePlayBtn();
}

function nextAyah() { if (S.idx < S.ayahs.length - 1) playAyah(S.idx + 1); }
function prevAyah() { if (S.idx > 0) playAyah(S.idx - 1); }

function toggleRepeat() {
  S.repeat = !S.repeat;
  document.getElementById('btn-repeat').classList.toggle('on', S.repeat);
  showToast(S.repeat ? 'üîÅ R√©p√©tition du verset activ√©e' : 'üîÅ R√©p√©tition d√©sactiv√©e');
}

function toggleAutoplay() {
  S.autoplay = !S.autoplay;
  document.getElementById('btn-autoplay').classList.toggle('on', S.autoplay);
  showToast(S.autoplay ? '‚è© Lecture automatique activ√©e' : '‚è© Lecture automatique d√©sactiv√©e');
}

function updatePlayBtn() {
  document.getElementById('play-btn').textContent = S.playing ? '‚è∏' : '‚ñ∂';
}

function updatePlayerInfo() {
  if (S.ayahs.length && S.ayahs[S.idx]) {
    const a = S.ayahs[S.idx];
    document.getElementById('player-surah').textContent = a.surah.name + ' ‚Äî ' + a.surah.englishName;
    document.getElementById('player-ayah').textContent = 'Verset ' + a.numberInSurah + ' sur ' + a.surah.numberOfAyahs;
  }
}

function highlightVerse(idx) {
  // Remove old highlights
  document.querySelectorAll('.verse.playing').forEach(function(el) { el.classList.remove('playing'); });
  document.querySelectorAll('.verse-play-btn.active-v').forEach(function(el) {
    el.classList.remove('active-v');
    el.textContent = '‚ñ∂ √âcouter';
  });

  // Add new highlight
  var el = document.getElementById('v-' + idx);
  if (el) {
    el.classList.add('playing');
    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
  var btn = document.getElementById('vb-' + idx);
  if (btn) {
    btn.classList.add('active-v');
    btn.textContent = '‚è∏ En cours';
  }
}

function seekAudio(e) {
  var bar = document.getElementById('player-progress');
  var pct = e.offsetX / bar.offsetWidth;
  if (audio.duration) audio.currentTime = pct * audio.duration;
}

// Audio events
audio.addEventListener('timeupdate', function() {
  if (audio.duration) {
    var pct = (audio.currentTime / audio.duration) * 100;
    document.getElementById('player-progress-fill').style.width = pct + '%';
  }
});

audio.addEventListener('ended', function() {
  if (S.repeat) {
    audio.currentTime = 0;
    audio.play().catch(function() {});
  } else if (S.autoplay && S.idx < S.ayahs.length - 1) {
    playAyah(S.idx + 1);
  } else {
    S.playing = false;
    updatePlayBtn();
    // Reset button
    var btn = document.getElementById('vb-' + S.idx);
    if (btn) { btn.classList.remove('active-v'); btn.textContent = '‚ñ∂ √âcouter'; }
  }
});

audio.addEventListener('error', function() {
  showToast('‚ö†Ô∏è Audio non disponible pour ce r√©citateur');
  S.playing = false;
  updatePlayBtn();
});

/* ================================================
   TABS
   ================================================ */
function switchTab(tab) {
  document.getElementById('tab-juz').classList.toggle('active', tab === 'juz');
  document.getElementById('tab-surah').classList.toggle('active', tab === 'surah');
  document.getElementById('juz-section').style.display = (tab === 'juz') ? '' : 'none';
  var surahEl = document.getElementById('surah-section');
  if (tab === 'surah') {
    surahEl.classList.add('active');
    renderSurahList();
  } else {
    surahEl.classList.remove('active');
  }
}

/* ================================================
   TRANSLATION
   ================================================ */
function toggleTranslation() {
  S.showTrans = !S.showTrans;
  document.getElementById('btn-trans').classList.toggle('on', S.showTrans);
  showToast(S.showTrans ? 'üåç Traduction affich√©e' : 'üåç Traduction masqu√©e');
  if (S.view === 'reader' && S.ayahs.length) renderVerses();
}

/* ================================================
   SETTINGS
   ================================================ */
function openSettings() { document.getElementById('settings-overlay').classList.add('show'); }
function closeSettings() { document.getElementById('settings-overlay').classList.remove('show'); }

function changeReciter(val) {
  S.reciter = val;
  localStorage.setItem('q_rec', val);
  showToast('üéôÔ∏è R√©citateur chang√©');
  if (S.playing) playAyah(S.idx);
}

function changeTranslation(val) {
  S.edition = val;
  localStorage.setItem('q_tr', val);
  S.cache = {};
  showToast('üåç Traduction chang√©e ‚Äî rechargement...');
  if (S.view === 'reader' && S.num) {
    if (S.type === 'juz') openJuz(S.num);
    else openSurah(S.num);
  }
}

function testReciter() {
  var testAudio = new Audio(CDN + '/' + S.reciter + '/1.mp3');
  testAudio.play().then(function() {
    showToast('üîä Test: Al-Fatiha, verset 1');
    setTimeout(function() { testAudio.pause(); }, 8000);
  }).catch(function() {
    showToast('‚ö†Ô∏è Ce r√©citateur ne semble pas disponible');
  });
}

/* ================================================
   KEYBOARD
   ================================================ */
document.addEventListener('keydown', function(e) {
  if (S.view !== 'reader') return;
  if (e.target.tagName === 'INPUT') return;
  if (e.key === ' ' || e.code === 'Space') { e.preventDefault(); togglePlay(); }
  if (e.key === 'ArrowRight') nextAyah();
  if (e.key === 'ArrowLeft') prevAyah();
  if (e.key === 'Escape') goHome();
});

/* ================================================
   INIT
   ================================================ */
(function() {
  document.getElementById('select-reciter').value = S.reciter;
  document.getElementById('select-translation').value = S.edition;
  document.getElementById('btn-trans').classList.toggle('on', S.showTrans);
  document.getElementById('btn-autoplay').classList.toggle('on', S.autoplay);
  renderJuzGrid();
})();

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(function() {});
}
</script>
</body>
</html>
